drop database te1234;
create database te1234;
USE te1234;


DROP TABLE IF EXISTS Borrower;
DROP TABLE IF EXISTS Fine;


CREATE TABLE Borrower (
  Roll_no INT PRIMARY KEY,
  Name VARCHAR(30),
  DOI DATE,
  NameofBook VARCHAR(50),
  Status VARCHAR(1)
);


INSERT INTO Borrower (Roll_no, Name, DOI, NameofBook, Status) VALUES
  (1, 'Sachin', '2025-11-01', 'DBMS', 'I'),
  (2, 'Ravi',  '2025-10-25', 'TOC',  'I'),
  (3, 'Vedika','2025-08-25', 'C++',  'I');


CREATE TABLE Fine (
  Roll_no INT,
  sDate DATE,
  Amt INT
);


DROP PROCEDURE IF EXISTS p_fine;
DELIMITER //
CREATE PROCEDURE p_fine(IN rno INT, IN bname VARCHAR(50))
BEGIN
  DECLARE d1 DATE;
  DECLARE daycnt INT DEFAULT 0;
  DECLARE fine_amt INT DEFAULT 0;

  
  SELECT DOI INTO d1
    FROM Borrower
    WHERE Roll_no = rno AND NameofBook = bname
    LIMIT 1;


  IF d1 IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'No matching borrower/book or DOI is NULL';
  ELSE
    SET daycnt = DATEDIFF(CURDATE(), d1);

    IF daycnt >= 15 AND daycnt <= 30 THEN
      SET fine_amt = daycnt * 5;
      INSERT INTO Fine (Roll_no, sDate, Amt) VALUES (rno, CURDATE(), fine_amt);
      UPDATE Borrower SET Status = 'R' WHERE Roll_no = rno;
    ELSEIF daycnt > 30 THEN
      SET fine_amt = daycnt * 50;
      INSERT INTO Fine (Roll_no, sDate, Amt) VALUES (rno, CURDATE(), fine_amt);
      UPDATE Borrower SET Status = 'R' WHERE Roll_no = rno;
    ELSE
     
      UPDATE Borrower SET Status = 'R' WHERE Roll_no = rno;
    END IF;
  END IF;
END;
//
DELIMITER ;


CALL p_fine(3,'C++');


SELECT * FROM Borrower;
SELECT * FROM Fine;
